services:
  mem-ui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: local-mem
    ports:
      - "8080:8080"
    volumes:
      # Mount local data for development (persists locally)
      - ./data:/app/data
      # Mount dev directory for repo scanning (read-only)
      # NOTE: Update this path to match your dev directory
      - /Users/chokevin/dev:/host-dev:ro
    environment:
      - MEM_PROFILE=test
      - MEM_DATA_DIR=/app/data
      - MEM_DEV_DIR=/host-dev
      # Temporal connection (use host.docker.internal for Mac/Windows Docker Desktop)
      - TEMPORAL_ADDRESS=host.docker.internal:7233
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/api/workstreams', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # Allow connection to host network for Temporal
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # MCP server service (optional, for API access)
  mem-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: local-mem-server
    command: ["python", "-m", "src.server"]
    ports:
      - "3000:3000"
    volumes:
      - mem-data:/app/data
    environment:
      - MEM_PROFILE=prod
      - MEM_DATA_DIR=/app/data
    restart: unless-stopped
    profiles:
      - full  # Only starts with: docker compose --profile full up

volumes:
  mem-data:
    driver: local
